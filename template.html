<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>{{FOLDER_NAME}} - Interactive Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        #sidebar {
            width: 300px;
            height: 100vh;
            background: #f5f5f5;
            border-right: 2px solid #ccc;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
        }

        #sidebar h3 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
            color: #333;
        }

        #graph {
            flex: 1;
            height: 100vh;
        }

        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .nodes circle {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .nodes circle:hover {
            stroke: #000;
            stroke-width: 3px;
        }

        .nodes circle.highlighted {
            stroke: #ff6600;
            stroke-width: 4px;
        }

        .labels text {
            font-size: 10px;
            pointer-events: none;
            user-select: none;
            fill: #333;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 12px;
        }

        /* Tree Navigation Styles */
        .tree-node {
            margin: 2px 0;
            cursor: pointer;
            user-select: none;
        }

        .tree-node-content {
            padding: 5px;
            border-radius: 3px;
            display: flex;
            align-items: center;
        }

        .tree-node-content:hover {
            background: #e0e0e0;
        }

        .tree-node-content.selected {
            background: #ffddaa;
            font-weight: bold;
        }

        .tree-toggle {
            display: inline-block;
            width: 16px;
            margin-right: 5px;
            text-align: center;
            font-weight: bold;
            color: #666;
        }

        .tree-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 5px;
            border-radius: 50%;
        }

        .tree-icon.file {
            background: red;
        }

        .tree-icon.class {
            background: purple;
        }

        .tree-icon.function {
            background: green;
        }

        .tree-icon.method {
            background: blue;
        }

        .tree-icon.child {
            background: yellow;
        }

        .tree-children {
            margin-left: 20px;
            display: none;
        }

        .tree-children.expanded {
            display: block;
        }

        .tree-label {
            flex: 1;
            font-size: 13px;
            color: #222;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="sidebar">
            <h3>Project Structure</h3>
            <div id="tree-container"></div>
        </div>
        <svg id="graph"></svg>
    </div>
    <div class="tooltip"></div>
    <script>
        const nodes = {{ NODES_DATA }};
        const links = {{ EDGES_DATA }};
        const treeData = {{ TREE_DATA }};

        const width = window.innerWidth - 300;
        const height = window.innerHeight;

        const svg = d3.select("#graph")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g");

        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 10])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // Create force simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links)
                .id(d => d.index)
                .distance(d => 100 / (d.weight || 1))
                .strength(0.3))
            .force("charge", d3.forceManyBody()
                .strength(d => -300 * (d.size / 5))
                .distanceMax(400))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide()
                .radius(d => d.size * 3 + 5)
                .strength(0.7));

        // Create links
        const link = g.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("stroke-width", d => Math.sqrt(d.weight || 1));

        // Create nodes
        const node = g.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("r", d => d.size * 2)
            .attr("fill", d => d.color)
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        // Create labels
        const labels = g.append("g")
            .attr("class", "labels")
            .selectAll("text")
            .data(nodes)
            .enter().append("text")
            .text(d => d.name)
            .attr("font-size", "10px")
            .attr("dx", d => d.size * 2 + 5)
            .attr("dy", 3);

        // Tooltip
        const tooltip = d3.select(".tooltip");

        node.on("mouseover", function (event, d) {
            tooltip
                .style("opacity", 1)
                .html(`<strong>${d.name}</strong><br>Type: ${d.type}<br>Size: ${d.size}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        })
            .on("mouseout", function () {
                tooltip.style("opacity", 0);
            });

        // Update positions on each tick
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            labels
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Tree Navigation Functions
        let selectedNodeId = null;

        function highlightNode(nodeId) {
            // Remove previous highlights
            node.classed("highlighted", false);
            d3.selectAll(".tree-node-content").classed("selected", false);

            // Highlight new node
            if (nodeId) {
                selectedNodeId = nodeId;
                node.classed("highlighted", d => d.id === nodeId);

                // Find and center on the node
                const targetNode = nodes.find(n => n.id === nodeId);
                if (targetNode && targetNode.x && targetNode.y) {
                    const transform = d3.zoomIdentity
                        .translate(width / 2, height / 2)
                        .scale(1.5)
                        .translate(-targetNode.x, -targetNode.y);

                    svg.transition()
                        .duration(750)
                        .call(zoom.transform, transform);
                }
            }
        }

        function renderTree(data, container) {
            data.forEach(item => {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'tree-node-content';
                contentDiv.dataset.nodeId = item.id;

                // Toggle icon
                const toggle = document.createElement('span');
                toggle.className = 'tree-toggle';
                if (item.children && item.children.length > 0) {
                    toggle.textContent = '▶';
                } else {
                    toggle.textContent = '';
                }
                contentDiv.appendChild(toggle);

                // Type icon
                const icon = document.createElement('span');
                icon.className = `tree-icon ${item.type}`;
                contentDiv.appendChild(icon);

                // Label
                const label = document.createElement('span');
                label.className = 'tree-label';
                label.textContent = item.name;
                label.title = item.name; // Tooltip for long names
                contentDiv.appendChild(label);

                nodeDiv.appendChild(contentDiv);

                // Children container
                if (item.children && item.children.length > 0) {
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'tree-children';
                    renderTree(item.children, childrenDiv);
                    nodeDiv.appendChild(childrenDiv);

                    // Toggle functionality
                    toggle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        childrenDiv.classList.toggle('expanded');
                        toggle.textContent = childrenDiv.classList.contains('expanded') ? '▼' : '▶';
                    });
                }

                // Click to highlight
                contentDiv.addEventListener('click', () => {
                    highlightNode(item.id);
                    contentDiv.classList.add('selected');
                });

                container.appendChild(nodeDiv);
            });
        }

        // Render the tree
        const treeContainer = document.getElementById('tree-container');
        renderTree(treeData, treeContainer);

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth - 300;
            const newHeight = window.innerHeight;
            svg.attr("width", newWidth).attr("height", newHeight);
            simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2));
            simulation.alpha(0.3).restart();
        });
    </script>
</body>

</html>